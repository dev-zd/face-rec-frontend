<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - FaceRec Pro</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Premium Background Blobs -->
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Premium Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-face-smile-beam"></i>
                </div>
                FaceRec Pro
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="scan.html" class="nav-link">Live Analysis</a>
                <a href="report.html" class="nav-link">Report</a>
                <a href="gallery.html" class="nav-link">Database</a>
                <a href="#" onclick="logout()" class="nav-link" style="color: var(--danger);"><i
                        class="fa-solid fa-right-from-bracket"></i> Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="margin-top: 100px; padding-bottom: 4rem;">
        <div style="max-width: 700px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 3rem;">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Register New Identity</h1>
                <p style="color: var(--text-muted); font-size: 1.1rem;">Securely add new individuals to the database.
                </p>
            </div>

            <div class="glass-card" style="padding: 2.5rem;">
                <form id="register-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" name="name" id="name" required placeholder="e.g. Jane Doe"
                            class="form-input">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label for="class_name">Class</label>
                            <select name="class_name" id="class_name" class="form-input" required>
                                <option value="" disabled selected>Select Class</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="age">Age</label>
                            <input type="number" name="age" id="age" placeholder="e.g. 15" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="department">Department</label>
                        <select name="department" id="department" class="form-input" required>
                            <option value="" disabled selected>Select Department</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="image">Select Photos (Min 5)</label>
                        <input type="file" name="image" id="image" required accept="image/*" multiple class="form-input"
                            style="padding: 0.5rem;" onchange="validateFileUpload()">
                        <small id="file-count-msg"
                            style="color: var(--text-muted); display: block; margin-top: 0.25rem;">No files
                            selected.</small>
                    </div>

                    <button type="submit" id="register-btn" class="btn-primary" style="width: 100%; margin-top: 1rem;"
                        disabled>
                        <span id="btn-text"><i class="fa-solid fa-cloud-arrow-up"></i> Upload and Register</span>
                        <span id="btn-loader" style="display: none;"><i class="fa-solid fa-circle-notch fa-spin"></i>
                            Processing...</span>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Notifications -->
    <div id="toast-container"
        style="position: fixed; top: 90px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;">
    </div>

    <script>
        const API_BASE = "http://localhost:8000";

        async function fetchMeta() {
            try {
                const response = await fetch(`${API_BASE}/api/register-meta/`);
                const data = await response.json();

                const classSelect = document.getElementById('class_name');
                data.class_options.forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = cls;
                    classSelect.appendChild(opt);
                });

                const deptSelect = document.getElementById('department');
                data.departments.forEach(dept => {
                    const opt = document.createElement('option');
                    opt.value = dept.id;
                    opt.textContent = dept.name;
                    deptSelect.appendChild(opt);
                });
            } catch (err) { }
        }

        function validateFileUpload() {
            const input = document.getElementById('image');
            const msg = document.getElementById('file-count-msg');
            const btn = document.getElementById('register-btn');
            const count = input.files.length;

            if (count < 5) {
                msg.innerText = `Only ${count} files selected. Minimum 5 required.`;
                msg.style.color = "var(--danger)";
                btn.disabled = true;
            } else {
                msg.innerText = `${count} files selected. Ready!`;
                msg.style.color = "var(--success)";
                btn.disabled = false;
            }
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast animate-fade-in';
            toast.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('register-btn');
            const text = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');

            btn.disabled = true;
            text.style.display = 'none';
            loader.style.display = 'inline-block';

            const formData = new FormData(e.target);
            try {
                const response = await fetch(`${API_BASE}/api/register//`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } else {
                    alert(result.error);
                    btn.disabled = false;
                    text.style.display = 'inline-block';
                    loader.style.display = 'none';
                }
            } catch (err) {
                btn.disabled = false;
                text.style.display = 'inline-block';
                loader.style.display = 'none';
            }
        });

        function logout() {
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        fetchMeta();
    </script>
</body>

</html>